import React, { useState, useEffect } from 'react'
import { useNavigate } from 'react-router-dom'
import axios from 'axios'

const API_URL = import.meta.env.VITE_API_URL || 'https://bot-visas-api.onrender.com'

function InformacionSeguroMedico() {
  const [tieneSeguro, setTieneSeguro] = useState(null)
  const [gestionSolicitada, setGestionSolicitada] = useState(false)
  const [comentarios, setComentarios] = useState('')
  const [loading, setLoading] = useState(false)
  const [guardado, setGuardado] = useState(false)
  const [estadoSeguro, setEstadoSeguro] = useState(null) // pendiente/aprobado/rechazado
  const [comentariosAdmin, setComentariosAdmin] = useState('')
  const [modoEdicion, setModoEdicion] = useState(false)
  const navigate = useNavigate()

  useEffect(() => {
    // Verificar autenticaci√≥n
    const estudianteId = localStorage.getItem('estudiante_id')
    if (!estudianteId) {
      navigate('/estudiante/login')
      return
    }
    
    cargarDatos()
  }, [])

  const cargarDatos = async () => {
    try {
      const estudianteId = localStorage.getItem('estudiante_id')
      const response = await axios.get(`${API_URL}/api/estudiantes/${estudianteId}`)
      
      if (response.data) {
        const data = response.data
        
        // Determinar si ya tiene seguro basado en si ha solicitado gesti√≥n
        if (data.gestion_seguro_solicitada) {
          setTieneSeguro('no')
          setGestionSolicitada(true)
        }
        
        setComentarios(data.comentarios_seguro_medico || '')
        setGuardado(true)
        
        // Cargar estado de la gesti√≥n por el admin
        setEstadoSeguro(data.estado_seguro_medico || 'pendiente')
        setComentariosAdmin(data.comentarios_seguro_medico || '')
        
        // Si ya fue procesado por el admin, no mostrar en modo edici√≥n por defecto
        if (data.estado_seguro_medico && data.estado_seguro_medico !== 'pendiente') {
          setModoEdicion(false)
        } else {
          setModoEdicion(true)
        }
      }
    } catch (error) {
      console.error('Error cargando datos:', error)
    }
  }

  const manejarSubmit = async (e) => {
    e.preventDefault()
    setLoading(true)

    try {
      const estudianteId = localStorage.getItem('estudiante_id')
      const datosActualizacion = {}

      if (tieneSeguro === 'si') {
        // Ya tiene seguro, no necesita gesti√≥n
        datosActualizacion.gestion_seguro_solicitada = false
        datosActualizacion.comentarios_seguro_medico = comentarios || null
      } else if (tieneSeguro === 'no' && gestionSolicitada) {
        // No tiene seguro y quiere que la empresa lo gestione
        datosActualizacion.gestion_seguro_solicitada = true
        datosActualizacion.comentarios_seguro_medico = comentarios || ''
      } else {
        // No tiene seguro pero no quiere gesti√≥n
        datosActualizacion.gestion_seguro_solicitada = false
        datosActualizacion.comentarios_seguro_medico = comentarios || null
      }

      await axios.put(`${API_URL}/api/estudiantes/${estudianteId}`, datosActualizacion)
      
      setGuardado(true)
      setModoEdicion(false) // Salir del modo edici√≥n despu√©s de guardar
      alert('‚úÖ Informaci√≥n de seguro m√©dico actualizada correctamente')
      
    } catch (error) {
      console.error('Error guardando:', error)
      alert('‚ùå Error al guardar la informaci√≥n: ' + (error.response?.data?.detail || error.message))
    } finally {
      setLoading(false)
    }
  }

  return (
    <div style={{
      maxWidth: '800px',
      margin: '40px auto',
      padding: '30px',
      backgroundColor: '#ffffff',
      borderRadius: '15px',
      boxShadow: '0 10px 25px rgba(0,0,0,0.1)',
      border: '1px solid #e1e5e9'
    }}>
      {/* Header */}
      <div style={{
        textAlign: 'center',
        marginBottom: '30px',
        paddingBottom: '20px',
        borderBottom: '2px solid #f0f0f0'
      }}>
        <h1 style={{
          color: '#2d3748',
          fontSize: '28px',
          fontWeight: '700',
          marginBottom: '10px',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          gap: '10px'
        }}>
          üè• Informaci√≥n de Seguro M√©dico
        </h1>
        <p style={{
          color: '#718096',
          fontSize: '16px',
          margin: 0
        }}>
          Gestiona tu seguro m√©dico para tu estancia en Espa√±a
        </p>
      </div>

      {/* Vista de estado procesado */}
      {estadoSeguro && estadoSeguro !== 'pendiente' && !modoEdicion ? (
        <div>
          {/* Estado de la solicitud */}
          <div style={{
            padding: '30px',
            backgroundColor: estadoSeguro === 'aprobado' ? '#d1fae5' : '#fee2e2',
            border: `3px solid ${estadoSeguro === 'aprobado' ? '#10b981' : '#ef4444'}`,
            borderRadius: '15px',
            textAlign: 'center',
            marginBottom: '25px'
          }}>
            <div style={{
              fontSize: '48px',
              marginBottom: '15px'
            }}>
              {estadoSeguro === 'aprobado' ? '‚úÖ' : '‚ùå'}
            </div>
            <h2 style={{
              color: estadoSeguro === 'aprobado' ? '#065f46' : '#991b1b',
              fontSize: '24px',
              fontWeight: '700',
              marginBottom: '10px'
            }}>
              Solicitud de Seguro M√©dico {estadoSeguro === 'aprobado' ? 'APROBADA' : 'RECHAZADA'}
            </h2>
            <p style={{
              color: estadoSeguro === 'aprobado' ? '#047857' : '#dc2626',
              fontSize: '16px',
              margin: 0
            }}>
              {estadoSeguro === 'aprobado' 
                ? 'Tu solicitud ha sido aprobada por nuestro equipo' 
                : 'Tu solicitud ha sido rechazada por nuestro equipo'
              }
            </p>
          </div>

          {/* Comentarios del admin */}
          {comentariosAdmin && (
            <div style={{
              padding: '20px',
              backgroundColor: '#f8fafc',
              border: '2px solid #e2e8f0',
              borderRadius: '10px',
              marginBottom: '25px'
            }}>
              <h3 style={{
                color: '#374151',
                fontSize: '16px',
                fontWeight: '600',
                marginBottom: '10px',
                display: 'flex',
                alignItems: 'center',
                gap: '8px'
              }}>
                üí¨ Comentarios del equipo
              </h3>
              <p style={{
                color: '#6b7280',
                fontSize: '14px',
                lineHeight: '1.6',
                margin: 0
              }}>
                {comentariosAdmin}
              </p>
            </div>
          )}

          {/* Bot√≥n editar */}
          <div style={{ textAlign: 'center' }}>
            <button
              onClick={() => setModoEdicion(true)}
              style={{
                backgroundColor: '#3b82f6',
                color: 'white',
                border: 'none',
                padding: '12px 30px',
                borderRadius: '8px',
                fontSize: '16px',
                fontWeight: '600',
                cursor: 'pointer',
                transition: 'all 0.2s',
                boxShadow: '0 4px 12px rgba(59, 130, 246, 0.2)'
              }}
            >
              ‚úèÔ∏è Editar Informaci√≥n
            </button>
          </div>
        </div>
      ) : (
        /* Formulario de edici√≥n */

      <form onSubmit={manejarSubmit}>
        {/* Pregunta principal sobre seguro */}
        <div style={{
          marginBottom: '30px',
          padding: '25px',
          backgroundColor: '#f7fafc',
          borderRadius: '10px',
          border: '2px solid #e2e8f0'
        }}>
          <label style={{
            display: 'block',
            fontSize: '18px',
            fontWeight: '600',
            color: '#2d3748',
            marginBottom: '15px'
          }}>
            ¬øYa tienes seguro m√©dico para tu estancia en Espa√±a?
          </label>
          
          <div style={{ display: 'flex', gap: '20px', flexWrap: 'wrap' }}>
            <label style={{
              display: 'flex',
              alignItems: 'center',
              cursor: 'pointer',
              padding: '12px 20px',
              backgroundColor: tieneSeguro === 'si' ? '#d1fae5' : '#ffffff',
              border: `2px solid ${tieneSeguro === 'si' ? '#10b981' : '#d1d5db'}`,
              borderRadius: '8px',
              transition: 'all 0.2s'
            }}>
              <input
                type="radio"
                name="tieneSeguro"
                value="si"
                checked={tieneSeguro === 'si'}
                onChange={(e) => {
                  setTieneSeguro(e.target.value)
                  setGestionSolicitada(false)
                }}
                style={{ marginRight: '10px', width: '18px', height: '18px' }}
              />
              <span style={{ fontWeight: '500', color: '#374151' }}>
                ‚úÖ S√≠, ya tengo seguro
              </span>
            </label>

            <label style={{
              display: 'flex',
              alignItems: 'center',
              cursor: 'pointer',
              padding: '12px 20px',
              backgroundColor: tieneSeguro === 'no' ? '#fef3c7' : '#ffffff',
              border: `2px solid ${tieneSeguro === 'no' ? '#f59e0b' : '#d1d5db'}`,
              borderRadius: '8px',
              transition: 'all 0.2s'
            }}>
              <input
                type="radio"
                name="tieneSeguro"
                value="no"
                checked={tieneSeguro === 'no'}
                onChange={(e) => setTieneSeguro(e.target.value)}
                style={{ marginRight: '10px', width: '18px', height: '18px' }}
              />
              <span style={{ fontWeight: '500', color: '#374151' }}>
                ‚ùå No, necesito seguro
              </span>
            </label>
          </div>
        </div>

        {/* Gesti√≥n por la empresa (solo si no tiene seguro) */}
        {tieneSeguro === 'no' && (
          <div style={{
            marginBottom: '30px',
            padding: '25px',
            backgroundColor: '#fef9e7',
            borderRadius: '10px',
            border: '2px solid #f59e0b'
          }}>
            <label style={{
              display: 'block',
              fontSize: '18px',
              fontWeight: '600',
              color: '#92400e',
              marginBottom: '15px'
            }}>
              ¬øQuieres que nuestra empresa gestione tu seguro m√©dico?
            </label>
            
            <div style={{ display: 'flex', gap: '20px', flexWrap: 'wrap' }}>
              <label style={{
                display: 'flex',
                alignItems: 'center',
                cursor: 'pointer',
                padding: '12px 20px',
                backgroundColor: gestionSolicitada ? '#d1fae5' : '#ffffff',
                border: `2px solid ${gestionSolicitada ? '#10b981' : '#d1d5db'}`,
                borderRadius: '8px',
                transition: 'all 0.2s'
              }}>
                <input
                  type="radio"
                  name="gestionSolicitada"
                  value="si"
                  checked={gestionSolicitada}
                  onChange={() => setGestionSolicitada(true)}
                  style={{ marginRight: '10px', width: '18px', height: '18px' }}
                />
                <span style={{ fontWeight: '500', color: '#374151' }}>
                  üëç S√≠, que la empresa me lo gestione
                </span>
              </label>

              <label style={{
                display: 'flex',
                alignItems: 'center',
                cursor: 'pointer',
                padding: '12px 20px',
                backgroundColor: !gestionSolicitada ? '#fee2e2' : '#ffffff',
                border: `2px solid ${!gestionSolicitada ? '#ef4444' : '#d1d5db'}`,
                borderRadius: '8px',
                transition: 'all 0.2s'
              }}>
                <input
                  type="radio"
                  name="gestionSolicitada"
                  value="no"
                  checked={!gestionSolicitada}
                  onChange={() => setGestionSolicitada(false)}
                  style={{ marginRight: '10px', width: '18px', height: '18px' }}
                />
                <span style={{ fontWeight: '500', color: '#374151' }}>
                  üö´ No, lo buscar√© yo mismo
                </span>
              </label>
            </div>
          </div>
        )}

        {/* Informaci√≥n m√©dica adicional */}
        <div style={{
          marginBottom: '30px',
          padding: '25px',
          backgroundColor: '#f0f9ff',
          borderRadius: '10px',
          border: '2px solid #0ea5e9'
        }}>
          <label style={{
            display: 'block',
            fontSize: '16px',
            fontWeight: '600',
            color: '#075985',
            marginBottom: '15px'
          }}>
            Informaci√≥n m√©dica adicional (opcional)
          </label>
          <p style={{
            fontSize: '14px',
            color: '#64748b',
            marginBottom: '10px'
          }}>
            Incluye condiciones m√©dicas, medicamentos que tomas, alergias, o cualquier informaci√≥n relevante para el seguro.
          </p>
          <textarea
            value={comentarios}
            onChange={(e) => setComentarios(e.target.value)}
            placeholder="Ej: Tomo medicaci√≥n para la diabetes, alergia a la penicilina, etc."
            rows="4"
            style={{
              width: '100%',
              padding: '12px',
              border: '2px solid #cbd5e1',
              borderRadius: '8px',
              fontSize: '14px',
              fontFamily: 'inherit',
              resize: 'vertical'
            }}
          />
        </div>

        {/* Bot√≥n de env√≠o */}
        <div style={{ textAlign: 'center' }}>
          <button
            type="submit"
            disabled={loading || !tieneSeguro}
            style={{
              backgroundColor: loading ? '#9ca3af' : '#7c3aed',
              color: 'white',
              border: 'none',
              padding: '15px 40px',
              borderRadius: '8px',
              fontSize: '16px',
              fontWeight: '600',
              cursor: loading || !tieneSeguro ? 'not-allowed' : 'pointer',
              transition: 'all 0.2s',
              boxShadow: '0 4px 12px rgba(124, 58, 237, 0.2)'
            }}
          >
            {loading ? 'üîÑ Guardando...' : guardado ? '‚úÖ Actualizar Informaci√≥n' : 'üìù Guardar Informaci√≥n'}
          </button>
        </div>
      </form>

      {/* Aviso si est√° editando una solicitud procesada */}
      {estadoSeguro && estadoSeguro !== 'pendiente' && (
        <div style={{
          marginTop: '20px',
          padding: '15px',
          backgroundColor: '#fef3c7',
          border: '2px solid #f59e0b',
          borderRadius: '8px',
          display: 'flex',
          justifyContent: 'space-between',
          alignItems: 'center'
        }}>
          <span style={{ color: '#92400e', fontWeight: '500' }}>
            ‚ö†Ô∏è Editando solicitud ya procesada
          </span>
          <button
            type="button"
            onClick={() => setModoEdicion(false)}
            style={{
              backgroundColor: '#6b7280',
              color: 'white',
              border: 'none',
              padding: '8px 16px',
              borderRadius: '6px',
              fontSize: '14px',
              cursor: 'pointer'
            }}
          >
            Cancelar
          </button>
        </div>
      )}

      {/* Informaci√≥n importante */}
      <div style={{
        marginTop: '30px',
        padding: '20px',
        backgroundColor: '#fffbeb',
        border: '2px solid #f59e0b',
        borderRadius: '10px'
      }}>
        <h3 style={{
          color: '#92400e',
          fontSize: '16px',
          fontWeight: '600',
          marginBottom: '10px',
          display: 'flex',
          alignItems: 'center',
          gap: '8px'
        }}>
          ‚ÑπÔ∏è Informaci√≥n importante
        </h3>
        <ul style={{ fontSize: '14px', color: '#78350f', lineHeight: '1.6', paddingLeft: '20px' }}>
          <li>El seguro m√©dico es <strong>obligatorio</strong> para obtener la visa de estudiante</li>
          <li>Debe cubrir al menos <strong>30.000‚Ç¨ en gastos m√©dicos</strong></li>
          <li>Si nuestra empresa gestiona tu seguro, te contactaremos con las opciones disponibles</li>
          <li>Puedes actualizar esta informaci√≥n cuando lo necesites</li>
        </ul>
      </div>
    </div>
  )
}

export default InformacionSeguroMedico